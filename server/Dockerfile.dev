# Development Dockerfile with hot reloading
FROM rust:latest

# Install cargo-watch for auto-reloading
RUN cargo install cargo-watch

# Install build dependencies
RUN apt-get update && apt-get install -y \
    pkg-config \
    libssl-dev \
    protobuf-compiler \
    && rm -rf /var/lib/apt/lists/*

# Create app directory
WORKDIR /usr/src/app

# Copy only Cargo files first to cache dependencies
COPY Cargo.toml Cargo.lock ./
COPY server/Cargo.toml ./server/
COPY common/Cargo.toml ./common/
COPY macros/Cargo.toml ./macros/
COPY client/Cargo.toml ./client/
COPY terminal/Cargo.toml ./terminal/

# Create dummy source files to build dependencies
RUN mkdir -p server/src common/src macros/src client/src terminal/src && \
    echo "fn main() {}" > server/src/main.rs && \
    echo "fn main() {}" > server/src/lib.rs && \
    echo "fn main() {}" > common/src/lib.rs && \
    echo "fn main() {}" > macros/src/lib.rs && \
    echo "fn main() {}" > client/src/lib.rs && \
    echo "fn main() {}" > terminal/src/main.rs && \
    echo "fn main() {}" > terminal/src/lib.rs

# Build dependencies only
RUN cargo build --release --bin server

# Remove dummy source files
RUN rm -rf server/src common/src macros/src client/src terminal/src

# The actual source will be mounted as volumes

# Expose ports
EXPOSE 8080 3001 50051 50052

# Install Node.js and wasm-pack for client build
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && \
    apt-get install -y nodejs && \
    curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

# Install Python and build tools for native Node modules
RUN apt-get update && apt-get install -y \
    python3 \
    make \
    g++ \
    && rm -rf /var/lib/apt/lists/*

# Copy development startup script
COPY scripts/dev-start.sh /usr/local/bin/dev-start.sh
RUN chmod +x /usr/local/bin/dev-start.sh

# Use the development startup script
CMD ["/usr/local/bin/dev-start.sh"]